<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <style>
        h2 {text-align: center;}
        form {background-color: lightgrey; }
        div {text-align: center;}
    </style>

    <meta charset="UTF-8">

    <title>Converter</title>
</head>

<body>
<form action="#" th:method="POST" th:action="@{/}" th:object="${operation}">
    <h2 style="padding-top: 30px">Конвертер валют</h2>

    <hr>

    <div>
        <select name="fromValute" id="fromValute" style="margin: 20px; width: 225px">
            <option th:field="*{fromCurrency}" th:each="currency : ${allCurrencies}" th:nominal ="${currency.nominal}" th:value="${currency.value}" th:label = "${currency.name}"></option>
        </select>

        <select name="toValute" id="toValute" style="margin: 20px; width: 225px">
            <option th:field="*{toCurrency}" th:each="currency : ${allCurrencies}" th:nominal ="${currency.nominal}" th:value="${currency.value}" th:label = "${currency.name}"></option>
        </select>

        <br>

        <input th:field="*{sum}" type="text" name="fromAmount" id="fromAmount" style="margin: 20px">
        <input th:field="*{result}" type="text" name="toAmount" id="toAmount" style="margin: 20px">

        <br>

        <button type="button" style="background-color: gray; width: 225px; margin: 20px" onclick="conversionIntoDB();">Конвертировать</button>
    </div>
</form>

<form>
    <h2 style="padding-top: 25px">История</h2>

    <div>
        <hr>Выберете дату операции</hr>

        &emsp;

        <input type="date" name="operationDate" id = "operationDate">


    </div>
</form>

<script type = "text/javascript" th:src="@{/js/big.js}"></script>

<script type = "text/javascript">
    function conversionIntoDB(){
        let sumToConvert = document.getElementById("fromAmount").value;

        if (!checkValidation(sumToConvert)) return;

        const ROUNDING = 10000;

        sumToConvert = new Big(sumToConvert);

        let fromValute = document.getElementById("fromValute");
        let toValute = document.getElementById("toValute");

        let fromNominal = new Big(fromValute.options[fromValute.selectedIndex].attributes.getNamedItem("nominal").value);
        let fromValue = new Big(fromValute.options[fromValute.selectedIndex].attributes.getNamedItem("value").value);
        let toNominal = new Big(toValute.options[toValute.selectedIndex].attributes.getNamedItem("nominal").value);
        let toValue = new Big(toValute.options[toValute.selectedIndex].attributes.getNamedItem("value").value);

        let fromUnit = fromValue / fromNominal;
        let toUnit = toValue / toNominal;

        document.getElementById("toAmount").value = Math.floor(fromUnit * sumToConvert / toUnit * ROUNDING) / ROUNDING;
    }

    function checkValidation(sumToConvert){
        let regexp = /(^\d{1,11}[.,]\d{1,4}$)|(^\d{1,11}$)/

        return regexp.test(sumToConvert);
    }
</script>
</body>
</html>